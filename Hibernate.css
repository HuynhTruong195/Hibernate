ORM lÃ  gÃ¬?
ORM (Object-Relational Mapping) lÃ  má»™t ká»¹ thuáº­t láº­p trÃ¬nh giÃºp Ã¡nh xáº¡ (mapping) giá»¯a cÃ¡c Ä‘á»‘i tÆ°á»£ng trong ngÃ´n ngá»¯ láº­p trÃ¬nh hÆ°á»›ng Ä‘á»‘i tÆ°á»£ng (nhÆ° Java) vá»›i cÃ¡c báº£ng trong cÆ¡ sá»Ÿ dá»¯ liá»‡u quan há»‡ (RDBMS)
ORM cho phÃ©p láº­p trÃ¬nh viÃªn thao tÃ¡c vá»›i cÆ¡ sá»Ÿ dá»¯ liá»‡u thÃ´ng qua cÃ¡c Ä‘á»‘i tÆ°á»£ng mÃ  khÃ´ng cáº§n viáº¿t trá»±c tiáº¿p cÃ¡c cÃ¢u lá»‡nh SQL

CÃ¡ch ORM hoáº¡t Ä‘á»™ng
Má»—i class Java tÆ°Æ¡ng á»©ng vá»›i má»™t table trong cÆ¡ sá»Ÿ dá»¯ liá»‡u
Má»—i instance (Ä‘á»‘i tÆ°á»£ng) tÆ°Æ¡ng á»©ng vá»›i má»™t record (hÃ ng dá»¯ liá»‡u)
CÃ¡c field trong class tÆ°Æ¡ng á»©ng vá»›i cÃ¡c column trong báº£ng
ORM sáº½ tá»± Ä‘á»™ng chuyá»ƒn Ä‘á»•i dá»¯ liá»‡u giá»¯a Object vÃ  dá»¯ liá»‡u trong database (mapping dá»¯ liá»‡u)

CÃ¡c ORM Framework phá»• biáº¿n trong Java
Hibernate : 	
Phá»• biáº¿n nháº¥t, há»— trá»£ HQL (Hibernate Query Language), caching máº¡nh

JPA (Java Persistence API): 
Chuáº©n Java cho ORM, thÆ°á»ng dÃ¹ng vá»›i Hibernate lÃ m hiá»‡n thá»±c

Spring Data JPA: 	
Dá»±a trÃªn JPA, tÃ­ch há»£p sáºµn vá»›i Spring Boot

    VÃ­ dá»¥ Ä‘Æ¡n giáº£n vá»›i Hibernate (Annotation-based)

@Entity
@Table(name = "Users")
    public class User {
        @Id
        @GeneratedValue(strategy = GenerationType.IDENTITY)
            private Long id;

        @Column(name ="username")
            private String username;

        @Colum(name = "email")
            private String email;

        //getters, setters

    }

Annotation @Entity xÃ¡c Ä‘á»‹nh Ä‘Ã¢y lÃ  Entity class
@Table Ã¡nh xáº¡ vá»›i báº£ng users
@Id xÃ¡c Ä‘á»‹nh khÃ³a chÃ­nh
ORM sáº½ tá»± Ä‘á»™ng Ã¡nh xáº¡ cÃ¡c field sang column tÆ°Æ¡ng á»©ng
 

Hibernate lÃ  gÃ¬?
Hibernate lÃ  má»™t framework mÃ£ nguá»“n má»Ÿ cá»§a Java, giÃºp thá»±c hiá»‡n ORM (Object-Relational Mapping)
Hibernate Ä‘Ã³ng vai trÃ² lÃ  táº§ng trung gian giá»¯a á»©ng dá»¥ng Java vÃ  cÆ¡ sá»Ÿ dá»¯ liá»‡u, tá»± Ä‘á»™ng Ã¡nh xáº¡ (mapping) giá»¯a cÃ¡c Ä‘á»‘i tÆ°á»£ng Java (POJO) vÃ  báº£ng trong CSDL
Hibernate quáº£n lÃ½ CRUD, Ã¡nh xáº¡ quan há»‡, lazy loading, cache, transaction, query HQLâ€¦
 

Æ¯u Ä‘iá»ƒm cá»§a Hibernate
KhÃ´ng cáº§n viáº¿t SQL thá»§ cÃ´ng cho CRUD
Há»— trá»£ HQL (Hibernate Query Language) â€“ NgÃ´n ngá»¯ truy váº¥n hÆ°á»›ng Ä‘á»‘i tÆ°á»£ng
Tá»± Ä‘á»™ng quáº£n lÃ½ cache, lazy loading
Dá»… dÃ ng tÃ­ch há»£p vá»›i Spring Framework
Há»— trá»£ nhiá»u loáº¡i cÆ¡ sá»Ÿ dá»¯ liá»‡u thÃ´ng qua cáº¥u hÃ¬nh
 

CÃ¡c khÃ¡i niá»‡m chÃ­nh trong Hibernate
    SessionFactory: Äá»‘i tÆ°á»£ng khá»Ÿi táº¡o session (káº¿t ná»‘i), Ä‘Æ°á»£c táº¡o 1 láº§n
    Session: 	Äá»‘i tÆ°á»£ng lÃ m viá»‡c trá»±c tiáº¿p vá»›i DB (open/close), giá»‘ng DAO
    Transaction: Quáº£n lÃ½ giao dá»‹ch
    Entity: Lá»›p Ã¡nh xáº¡ vá»›i báº£ng trong DB

@Entity
@Table(name = "category")
public class Category implements Serializable { //seriali giÃºp Ä‘á»“ng bá»™ khi hoáº¡t Ä‘á»™ng trÃªn internet
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int category_id;
    private String category_name;
    private String category_ds;
    private Boolean category_status;

    //getter, setter



public class HibernateUtils {
    private static final SessionFactory sessionFactory = buildSessionFactory();

    private static SessionFactory buildSessionFactory() {
        try {
            Properties prop = new Properties(); //táº¡o 1 obj chá»©a thÃ´ng tin cáº¥ hÃ¬nh hibernate thay file XML
            prop.put(Environment.DIALECT, "org.hibernate.dialect.MySQL8Dialect");
            prop.put(Environment.DRIVER, "com.mysql.cj.jdbc.Driver");
            prop.put(Environment.URL, "jdbc:mysql://localhost:3306/categorymanagement_db");
            prop.put(Environment.USER, "root");
            prop.put(Environment.PASS, "Weak");
            prop.put(Environment.SHOW_SQL, "true");
            prop.put(Environment.HBM2DDL_AUTO, "update");

            // ServiceRegistry lÃ  Ä‘á»‘i tÆ°á»£ng trung gian giÃºp Hibernate táº¡o SessionFactory tá»« cáº¥u hÃ¬nh.
            ServiceRegistry registry = new StandardServiceRegistryBuilder()
                    .applySettings(prop)
                    .build();
            //táº¡o Sessionfactory
            return new Configuration() //khá»Ÿi táº¡o
                    .addProperties(prop) //thÃªm cáº¥u hÃ¬nh vÃ o
                    .addAnnotatedClass(Category.class) //Ä‘Äƒng kÃ½ entity class Category cÃ³ @Entity
                    .buildSessionFactory(registry); // táº¡o SessionFactory
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }

    public static SessionFactory getSessionFactory() {
        return sessionFactory;
    }
}




public class HibernateTest {
    public static void main(String[] args) {
        try{
            Session session = HibernateUtils.getSessionFactory().openSession();

         //update
            Category c = session.get(Category.class, 13); // persisten
            c.setCategory_ds("Du lieu cap nhat");
        // báº­t giao tÃ¡c Ä‘á»ƒ trÃ¡nh tranh cháº¥p dá»¯ liá»‡u
            Transaction tx = session.beginTransaction();
            session.save(c); // thá»±c hiá»‡n lá»‡h cáº­p nháº­t
            tx.commit();
            
            
           // creat - khÃ´ng cáº§n táº¡o giao tÃ¡c vÃ¬ k cÃ³ ai tranh cháº¥p dá»¯ liá»‡u
            Category category = new Category();  --transient
            category.setCategory_name("Iphone");
            category.setCategory_ds("Dien Thoai DI Dong Thong Minh");
            category.setCategory_ds("telephone");
            session.save(category);

            session.close();

        }catch(Exception e){
            throw new RuntimeException(e);
        }
    }
}




ğŸ”„ Transaction lÃ  gÃ¬?
Transaction (giao dá»‹ch) lÃ  má»™t Ä‘Æ¡n vá»‹ cÃ´ng viá»‡c logic bao gá»“m má»™t hoáº·c nhiá»u thao tÃ¡c (insert, update, delete...) Ä‘Æ°á»£c thá»±c hiá»‡n nhÆ° má»™t khá»‘i nguyÃªn tá»­ (atomic). Tá»©c lÃ :

ThÃ nh cÃ´ng â†’ commit toÃ n bá»™
Lá»—i á»Ÿ giá»¯a â†’ rollback toÃ n bá»™

SELECT (chá»‰ Ä‘á»c dá»¯ liá»‡u)	    âŒ KhÃ´ng cáº§n	KhÃ´ng thay Ä‘á»•i DB, khÃ´ng lo xung Ä‘á»™t
INSERT, UPDATE, DELETE	        âœ… Cáº§n	CÃ³ thá»ƒ thay Ä‘á»•i dá»¯ liá»‡u, cáº§n Ä‘áº£m báº£o toÃ n váº¹n
Nhiá»u thao tÃ¡c liÃªn quan nhau	âœ… Cáº§n	Äáº£m báº£o atomic â€” táº¥t cáº£ hoáº·c khÃ´ng gÃ¬ cáº£
Gá»i stored procedure cÃ³ logic thay Ä‘á»•i dá»¯ liá»‡u	âœ… Cáº§n	VÃ¬ procedure cÃ³ thá»ƒ update nhiá»u báº£ng
ğŸ”¥ Khi nÃ o báº¯t buá»™c pháº£i dÃ¹ng Transaction?
    @Transactional
    public void transferMoney(Long fromId, Long toId, double amount) {
        Account from = accountRepo.findById(fromId).get();
        Account to = accountRepo.findById(toId).get();
        
        from.setBalance(from.getBalance() - amount);
        to.setBalance(to.getBalance() + amount);
        
        accountRepo.save(from);
        accountRepo.save(to);
    }
Náº¿u khÃ´ng cÃ³ @Transactional, lá»—i giá»¯a chá»«ng (VD: máº¥t káº¿t ná»‘i) sáº½ khiáº¿n tÃ i khoáº£n bá»‹ lá»‡ch, tiá»n máº¥t tÃ­ch ğŸ§¨


âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…

Entity Relationship : @ManyToOne, @ManyToMany, @OneToMany, @OneToOne

âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…

ğŸ”¹ @ManyToOne
Nhiá»u báº£n ghi á»Ÿ báº£ng nÃ y liÃªn káº¿t tá»›i 1 báº£n ghi á»Ÿ báº£ng khÃ¡c.

VÃ­ dá»¥:
    @ManyToOne
    @JoinColumn(name = "department_id")
    private Department department;

ğŸ“Œ Ã nghÄ©a:
    Nhiá»u nhÃ¢n viÃªn thuá»™c 1 phÃ²ng ban â†’ Employee lÃ  Many, Department lÃ  One.
    Táº¡o khÃ³a ngoáº¡i department_id trong báº£ng employee.


ğŸ”¹ @OneToMany
Má»™t báº£n ghi á»Ÿ báº£ng nÃ y liÃªn káº¿t Ä‘áº¿n nhiá»u báº£n ghi á»Ÿ báº£ng khÃ¡c.
    VÃ­ dá»¥
        @OneToMany(mappedBy = "department")
    private List<Employee> employees;

ğŸ“Œ Ã nghÄ©a:
    Má»™t phÃ²ng ban cÃ³ nhiá»u nhÃ¢n viÃªn.
    Quan há»‡ ngÆ°á»£c vá»›i @ManyToOne, thÆ°á»ng dÃ¹ng mappedBy Ä‘á»ƒ khÃ´ng táº¡o thÃªm báº£ng trung gian.
    âœ… NÃªn dÃ¹ng káº¿t há»£p vá»›i @ManyToOne phÃ­a cÃ²n láº¡i.

ğŸ”¹ @OneToOne
1 báº£n ghi tÆ°Æ¡ng á»©ng Ä‘Ãºng 1 báº£n ghi khÃ¡c.

VÃ­ dá»¥:
    @OneToOne
    @JoinColumn(name = "user_id")
    private User user;

ğŸ“Œ Ã nghÄ©a:
    Má»—i User cÃ³ 1 Profile, má»—i Profile thuá»™c 1 User.
    Táº¡o khÃ³a ngoáº¡i user_id á»Ÿ báº£ng profile.


ğŸ”¹@ManyToMany
Nhiá»u báº£n ghi á»Ÿ báº£ng nÃ y liÃªn káº¿t vá»›i nhiá»u báº£n ghi á»Ÿ báº£ng kia.
    VÃ­ dá»¥:
    @ManyToMany
    @JoinTable( â†’ Chá»‰ Ä‘á»‹nh tÃªn báº£ng trung gian vÃ  cÃ¡c cá»™t khÃ³a ngoáº¡i.
        name = "student_course",    â†’ TÃªn báº£ng trung gian trong database
        joinColumns = @JoinColumn(name = "student_id"),â†’ Cá»™t student_id trong báº£ng trung gian dÃ¹ng Ä‘á»ƒ liÃªn káº¿t vá»›i Student (chÃ­nh lÃ  class hiá»‡n táº¡i).
        inverseJoinColumns = @JoinColumn(name = "course_id") â†’ Cá»™t course_id trong báº£ng trung gian dÃ¹ng Ä‘á»ƒ liÃªn káº¿t vá»›i Course (class bÃªn kia).
    )
    private List<Course> courses;

ğŸ“Œ Ã nghÄ©a:
    Má»™t sinh viÃªn há»c nhiá»u mÃ´n, vÃ  má»™t mÃ´n cÃ³ nhiá»u sinh viÃªn.
    Táº¡o báº£ng trung gian student_course Ä‘á»ƒ lÆ°u quan há»‡ nhiá»u-nhiá»u.

ğŸ§  Tá»•ng káº¿t báº£ng so sÃ¡nh
Annotation	    Ã nghÄ©a	             VÃ­ dá»¥	                 Ghi nhá»›
@ManyToOne	Nhiá»u â†’ Má»™t	    Nhiá»u Employee â†’ 1 Dept 	    Táº¡o FK
@OneToMany	Má»™t â†’ Nhiá»u 	1 Dept â†’ nhiá»u Employee	DÃ¹ng    mappedBy
@OneToOne	Má»™t â†” Má»™t	    User â†” Profile	DÃ¹ng             @JoinColumn
@ManyToMany	Nhiá»u â†” Nhiá»u	Student â†” Course	        DÃ¹ng báº£ng trung gian


âœ… CÃ¡ch nhá»› ngáº¯n gá»n:
Quan há»‡	Vai trÃ²	CÃ¡ch nhá»› nhanh
@ManyToOne--	BÃªn nhiá»u---	Giá»¯ khÃ³a ngoáº¡i (@JoinColumn)
@OneToMany--	BÃªn má»™t---	DÃ¹ng mappedBy Ã¡nh xáº¡ ngÆ°á»£c



BÃ€I Táº¬P 1 @Transactional

âœ… VÃ­ dá»¥ cá»¥ thá»ƒ:    
    @Service
    public class StudentService {

        @Autowired
        private StudentRepository studentRepository;

        @Transactional
        public void updateStudent(Student student) {
            studentRepository.update(student);
            
            // Náº¿u khÃ´ng cÃ³ lá»—i â†’ commit
            // Náº¿u cÃ³ lá»—i á»Ÿ Ä‘Ã¢y â†’ rollback toÃ n bá»™
            // int x = 1 / 0; // gÃ¢y lá»—i test rollback
        }
    }

ğŸ§  Báº¡n KHÃ”NG cáº§n viáº¿t thá»§ cÃ´ng nhÆ° Hibernate thuáº§n:
    // Hibernate thuáº§n â€” cáº§n lÃ m thá»§ cÃ´ng
    Session session = sessionFactory.openSession();
    Transaction tx = session.beginTransaction();

    try {
        // thá»±c hiá»‡n thao tÃ¡c
        tx.commit();
    } catch (Exception e) {
        tx.rollback();
    }
âœ… TÃ³m láº¡i:
ğŸ‘‰ Chá»‰ cáº§n @Transactional, báº¡n Ä‘Æ°á»£c xá»­ lÃ½ Ä‘áº§y Ä‘á»§ transaction â€” khÃ´ng cáº§n code thá»§ cÃ´ng beginTransaction(), commit(), rollback() ná»¯a



ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ 

ViewResolver â†’ Ã¡nh xáº¡ view: âœ…

DataSource â†’ driver, url, user/pass: âœ…

Properties â†’ cáº¥u hÃ¬nh hibernate: âœ…

SessionFactory â†’ add properties, scan package cÃ³ @Entity: âœ…

TransactionManager â†’ quáº£n lÃ½ giao dá»‹ch: âœ…

ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ 


âœ… 1. Cascade lÃ  gÃ¬?
Cascade dÃ¹ng Ä‘á»ƒ chá»‰ Ä‘á»‹nh cÃ¡c thao tÃ¡c tá»± Ä‘á»™ng lan sang entity liÃªn quan.

VÃ­ dá»¥: Khi báº¡n lÆ°u, xoÃ¡, hay merge má»™t entity cha, thÃ¬ cÃ¡c entity con liÃªn quan cÃ³ Ä‘Æ°á»£c thá»±c hiá»‡n thao tÃ¡c tÆ°Æ¡ng á»©ng khÃ´ng?

ğŸ’¡ VÃ­ dá»¥ dá»… hiá»ƒu:

@OneToMany(mappedBy = "category", cascade = CascadeType.ALL)
private List<Product> products;
    ğŸ‘‰ Khi báº¡n save(Category) â†’ JPA sáº½ tá»± Ä‘á»™ng save táº¥t cáº£ Product trong danh sÃ¡ch Ä‘Ã³ mÃ  báº¡n khÃ´ng cáº§n gá»i riÃªng tá»«ng cÃ¡i.

ğŸ¯ CÃ¡c loáº¡i CascadeType:
CascadeType	    Ã nghÄ©a
ALL     	Gá»“m táº¥t cáº£ cÃ¡c hÃ nh Ä‘á»™ng bÃªn dÆ°á»›i
PERSIST	    Khi gá»i persist() entity cha thÃ¬ persist luÃ´n entity con
MERGE	    Khi gá»i merge() thÃ¬ merge luÃ´n cÃ¡c entity con
REMOVE	    Khi xoÃ¡ entity cha thÃ¬ tá»± Ä‘á»™ng xoÃ¡ entity con
REFRESH	    Khi gá»i refresh() thÃ¬ cáº­p nháº­t láº¡i entity con
DETACH	    Khi gá»i detach() thÃ¬ tÃ¡ch luÃ´n entity con khá»i persistence context


ğŸ› ï¸ VÃ­ dá»¥ vá» Cascade:
    @OneToMany(mappedBy = "customer", cascade = CascadeType.PERSIST)
    private List<Invoince> invoices;

  ğŸ‘‰  Khi báº¡n lÆ°u má»™t Customer cÃ³ invoices, Hibernate sáº½ tá»± Ä‘á»™ng lÆ°u Invoice vÃ o database
 

âœ… 2. FetchType lÃ  gÃ¬?
FetchType dÃ¹ng Ä‘á»ƒ chá»‰ Ä‘á»‹nh cÃ¡ch JPA táº£i dá»¯ liá»‡u quan há»‡ khi truy váº¥n.

ğŸ¯ CÃ³ 2 loáº¡i chÃ­nh:
    FetchType	    Ã nghÄ©a
    EAGER	    Táº£i ngay láº­p tá»©c quan há»‡ khi truy váº¥n entity cha
    LAZY	    Chá»‰ táº£i khi cáº§n (truy cáº­p Ä‘áº¿n má»›i truy váº¥n

ğŸ’¡ VÃ­ dá»¥:
    @OneToMany(mappedBy = "category", fetch = FetchType.LAZY)
    private List<Product> products;

Khi báº¡n gá»i Category c = session.get(Category.class, 1);
â†’ Danh sÃ¡ch products sáº½ chÆ°a Ä‘Æ°á»£c táº£i cho Ä‘áº¿n khi báº¡n gá»i c.getProducts().


âš ï¸ LÆ°u Ã½ khi dÃ¹ng LAZY:
Náº¿u dÃ¹ng LAZY nhÆ°ng session Ä‘Ã£ Ä‘Ã³ng rá»“i, vÃ  báº¡n gá»i getProducts() â†’ lá»—i:
    LazyInitializationException

    CÃ¡ch xá»­ lÃ½:
DÃ¹ng DTO Ä‘á»ƒ map khi session cÃ²n má»Ÿ
DÃ¹ng fetch join trong JPQL/HQL


âœ… Gá»£i Ã½ cáº¥u hÃ¬nh chuáº©n cho thá»±c táº¿:
    ManyToOne: thÆ°á»ng lÃ  EAGER (default)

    @ManyToOne(fetch = FetchType.EAGER, cascade = CascadeType.PERSIST)
    @JoinColumn(name = "category_id")
    private Category category;

    OneToMany: thÆ°á»ng nÃªn lÃ  LAZY Ä‘á»ƒ trÃ¡nh náº·ng

    @OneToMany(mappedBy = "category", fetch = FetchType.LAZY, cascade = CascadeType.ALL)
    private List<Product> products;





ğŸ§¨ Váº¥n Ä‘á»: N + 1 Query
Khi báº¡n thá»±c hiá»‡n truy váº¥n nhÆ° sau:

    List<Customer> customers = customerRepository.findAll(); // Truy váº¥n 1

    for (Customer customer : customers) {
        List<Invoice> invoices = customer.getInvoices(); // Truy váº¥n N láº§n (má»—i customer má»™t truy váº¥n)
    }



ğŸ‘‰ Tá»•ng sá»‘ truy váº¥n SQL: 1 + N
    Náº¿u cÃ³ 1000 khÃ¡ch hÃ ng â†’ 1 + 1000 = 1001 truy váº¥n
    âŒ á»¨ng dá»¥ng ráº¥t cháº­m, tá»‘n tÃ i nguyÃªn

âœ… Giáº£i phÃ¡p: TrÃ¡nh N + 1 Query báº±ng Join Fetch
âœ… 1. DÃ¹ng @Query vá»›i JOIN FETCH trong repository

@Query("SELECT c FROM Customer c LEFT JOIN FETCH c.invoices")
List<Customer> findAllWithInvoices();

Hibernate chá»‰ thá»±c hiá»‡n 1 truy váº¥n duy nháº¥t:
SELECT c.*, i.* 
FROM customer c
LEFT JOIN invoice i ON i.customer_id = c.id

âš ï¸ Vá»›i quan há»‡ OneToMany thÃ¬ káº¿t quáº£ sáº½ bá»‹ "nhÃ¢n báº£n" khÃ¡ch hÃ ng náº¿u cÃ³ nhiá»u hoÃ¡ Ä‘Æ¡n â†’ dÃ¹ng Set hoáº·c DISTINCT Ä‘á»ƒ xá»­ lÃ½.


âœ… 2. DÃ¹ng EntityGraph (náº¿u báº¡n khÃ´ng muá»‘n viáº¿t JPQL)

@EntityGraph(attributePaths = "invoices")
@Query("SELECT c FROM Customer c")
List<Customer> findAllWithInvoices();

CÃ¡ch nÃ y sá»­ dá»¥ng annotation Ä‘á»ƒ khai bÃ¡o quan há»‡ cáº§n fetch, khÃ´ng cáº§n viáº¿t JOIN.


âœ… 3. Sá»­ dá»¥ng DTO Ä‘á»ƒ custom query (truy váº¥n dáº¡ng káº¿t há»£p)

    @Query("SELECT new com.example.dto.CustomerInvoiceDTO(c.name, i.totalAmount) " +
       "FROM Customer c LEFT JOIN c.invoices i")
    ist<CustomerInvoiceDTO> findCustomerInvoiceInfo();

 CÃ¡ch nÃ y truy váº¥n Ä‘Ãºng dá»¯ liá»‡u cáº§n, nháº¹ hÆ¡n ráº¥t nhiá»u vÃ¬ khÃ´ng pháº£i load cáº£ object.



âœ… 3. Káº¿t há»£p Cascade vÃ  Fetching - Má»™t vÃ­ dá»¥ thá»±c táº¿
Má»™t KhÃ¡ch hÃ ng (Customer) cÃ³ nhiá»u HÃ³a Ä‘Æ¡n (Invoice)
Khi lÆ°u khÃ¡ch hÃ ng má»›i, cÅ©ng muá»‘n lÆ°u luÃ´n hÃ³a Ä‘Æ¡n liÃªn quan
Khi láº¥y thÃ´ng tin khÃ¡ch hÃ ng, chá»‰ cáº§n láº¥y danh sÃ¡ch hÃ³a Ä‘Æ¡n khi cáº§n

VÃ Dá»¤: 
ğŸ”¹   Cascade â†’ Ä‘á»ƒ lÆ°u khÃ¡ch hÃ ng vÃ  hÃ³a Ä‘Æ¡n cÃ¹ng lÃºc
ğŸ”¹   FetchType.LAZY â†’ Ä‘á»ƒ chá»‰ táº£i danh sÃ¡ch hÃ³a Ä‘Æ¡n khi tháº­t sá»± cáº§n
ğŸ”¹"Customer cÃ³ nhiá»u Invoice" â†’ quan há»‡ @OneToMany


    âœ… 1. Cáº¥u trÃºc Entity: Customer vÃ  Invoice

ğŸ”¹ Customer.java
        @Entity
        @Table(name = "customer")
        public class Customer {
            @Id
            @GeneratedValue(strategy = GenerationType.IDENTITY)
            private Long id;

            private String name;

            // Má»™t khÃ¡ch hÃ ng cÃ³ nhiá»u hÃ³a Ä‘Æ¡n
            @OneToMany(mappedBy = "customer", 
                    cascade = CascadeType.PERSIST, 
                    fetch = FetchType.LAZY)
            private List<Invoice> invoices;

            // Getter, Setter, Constructor
        }


ğŸ”¹ Invoice.java
        @Entity
        @Table(name = "invoice")
        public class Invoice {

            @Id
            @GeneratedValue(strategy = GenerationType.IDENTITY)
            private Long id;

            private Double amount;

            @ManyToOne(fetch = FetchType.LAZY)
            @JoinColumn(name = "customer_id")
            private Customer customer;

            // Getter, Setter, Constructor
        }


âœ… 2. LÆ°u má»™t Customer cÃ¹ng vá»›i danh sÃ¡ch hÃ³a Ä‘Æ¡n

        Customer customer = new Customer();
        customer.setName("Nguyá»…n VÄƒn A");

        Invoice invoice1 = new Invoice();
        invoice1.setAmount(1000.0);
        invoice1.setCustomer(customer); // pháº£i gáº¯n ngÆ°á»£c láº¡i

        Invoice invoice2 = new Invoice();
        invoice2.setAmount(2000.0);
        invoice2.setCustomer(customer); // gáº¯n ngÆ°á»£c láº¡i

        customer.setInvoices(List.of(invoice1, invoice2));

        customerRepository.save(customer); // âœ… Cascade sáº½ lÆ°u luÃ´n invoice1 vÃ  invoice2
