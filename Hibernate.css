ORM lÃ  gÃ¬?
ORM (Object-Relational Mapping) lÃ  má»™t ká»¹ thuáº­t láº­p trÃ¬nh giÃºp Ã¡nh xáº¡ (mapping) giá»¯a cÃ¡c Ä‘á»‘i tÆ°á»£ng trong ngÃ´n ngá»¯ láº­p trÃ¬nh hÆ°á»›ng Ä‘á»‘i tÆ°á»£ng (nhÆ° Java) vá»›i cÃ¡c báº£ng trong cÆ¡ sá»Ÿ dá»¯ liá»‡u quan há»‡ (RDBMS)
ORM cho phÃ©p láº­p trÃ¬nh viÃªn thao tÃ¡c vá»›i cÆ¡ sá»Ÿ dá»¯ liá»‡u thÃ´ng qua cÃ¡c Ä‘á»‘i tÆ°á»£ng mÃ  khÃ´ng cáº§n viáº¿t trá»±c tiáº¿p cÃ¡c cÃ¢u lá»‡nh SQL

CÃ¡ch ORM hoáº¡t Ä‘á»™ng
Má»—i class Java tÆ°Æ¡ng á»©ng vá»›i má»™t table trong cÆ¡ sá»Ÿ dá»¯ liá»‡u
Má»—i instance (Ä‘á»‘i tÆ°á»£ng) tÆ°Æ¡ng á»©ng vá»›i má»™t record (hÃ ng dá»¯ liá»‡u)
CÃ¡c field trong class tÆ°Æ¡ng á»©ng vá»›i cÃ¡c column trong báº£ng
ORM sáº½ tá»± Ä‘á»™ng chuyá»ƒn Ä‘á»•i dá»¯ liá»‡u giá»¯a Object vÃ  dá»¯ liá»‡u trong database (mapping dá»¯ liá»‡u)

CÃ¡c ORM Framework phá»• biáº¿n trong Java
Hibernate : 	
Phá»• biáº¿n nháº¥t, há»— trá»£ HQL (Hibernate Query Language), caching máº¡nh

JPA (Java Persistence API): 
Chuáº©n Java cho ORM, thÆ°á»ng dÃ¹ng vá»›i Hibernate lÃ m hiá»‡n thá»±c

Spring Data JPA: 	
Dá»±a trÃªn JPA, tÃ­ch há»£p sáºµn vá»›i Spring Boot

    VÃ­ dá»¥ Ä‘Æ¡n giáº£n vá»›i Hibernate (Annotation-based)

@Entity
@Table(name = "Users")
    public class User {
        @Id
        @GeneratedValue(strategy = GenerationType.IDENTITY)
            private Long id;

        @Column(name ="username")
            private String username;

        @Colum(name = "email")
            private String email;

        //getters, setters

    }

Annotation @Entity xÃ¡c Ä‘á»‹nh Ä‘Ã¢y lÃ  Entity class
@Table Ã¡nh xáº¡ vá»›i báº£ng users
@Id xÃ¡c Ä‘á»‹nh khÃ³a chÃ­nh
ORM sáº½ tá»± Ä‘á»™ng Ã¡nh xáº¡ cÃ¡c field sang column tÆ°Æ¡ng á»©ng
 

Hibernate lÃ  gÃ¬?
Hibernate lÃ  má»™t framework mÃ£ nguá»“n má»Ÿ cá»§a Java, giÃºp thá»±c hiá»‡n ORM (Object-Relational Mapping)
Hibernate Ä‘Ã³ng vai trÃ² lÃ  táº§ng trung gian giá»¯a á»©ng dá»¥ng Java vÃ  cÆ¡ sá»Ÿ dá»¯ liá»‡u, tá»± Ä‘á»™ng Ã¡nh xáº¡ (mapping) giá»¯a cÃ¡c Ä‘á»‘i tÆ°á»£ng Java (POJO) vÃ  báº£ng trong CSDL
Hibernate quáº£n lÃ½ CRUD, Ã¡nh xáº¡ quan há»‡, lazy loading, cache, transaction, query HQLâ€¦
 

Æ¯u Ä‘iá»ƒm cá»§a Hibernate
KhÃ´ng cáº§n viáº¿t SQL thá»§ cÃ´ng cho CRUD
Há»— trá»£ HQL (Hibernate Query Language) â€“ NgÃ´n ngá»¯ truy váº¥n hÆ°á»›ng Ä‘á»‘i tÆ°á»£ng
Tá»± Ä‘á»™ng quáº£n lÃ½ cache, lazy loading
Dá»… dÃ ng tÃ­ch há»£p vá»›i Spring Framework
Há»— trá»£ nhiá»u loáº¡i cÆ¡ sá»Ÿ dá»¯ liá»‡u thÃ´ng qua cáº¥u hÃ¬nh
 

CÃ¡c khÃ¡i niá»‡m chÃ­nh trong Hibernate
    SessionFactory: Äá»‘i tÆ°á»£ng khá»Ÿi táº¡o session (káº¿t ná»‘i), Ä‘Æ°á»£c táº¡o 1 láº§n
    Session: 	Äá»‘i tÆ°á»£ng lÃ m viá»‡c trá»±c tiáº¿p vá»›i DB (open/close), giá»‘ng DAO
    Transaction: Quáº£n lÃ½ giao dá»‹ch
    Entity: Lá»›p Ã¡nh xáº¡ vá»›i báº£ng trong DB

@Entity
@Table(name = "category")
public class Category implements Serializable { //seriali giÃºp Ä‘á»“ng bá»™ khi hoáº¡t Ä‘á»™ng trÃªn internet
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int category_id;
    private String category_name;
    private String category_ds;
    private Boolean category_status;

    //getter, setter



public class HibernateUtils {
    private static final SessionFactory sessionFactory = buildSessionFactory();

    private static SessionFactory buildSessionFactory() {
        try {
            Properties prop = new Properties(); //táº¡o 1 obj chá»©a thÃ´ng tin cáº¥ hÃ¬nh hibernate thay file XML
            prop.put(Environment.DIALECT, "org.hibernate.dialect.MySQL8Dialect");
            prop.put(Environment.DRIVER, "com.mysql.cj.jdbc.Driver");
            prop.put(Environment.URL, "jdbc:mysql://localhost:3306/categorymanagement_db");
            prop.put(Environment.USER, "root");
            prop.put(Environment.PASS, "Weak");
            prop.put(Environment.SHOW_SQL, "true");
            prop.put(Environment.HBM2DDL_AUTO, "update");

            // ServiceRegistry lÃ  Ä‘á»‘i tÆ°á»£ng trung gian giÃºp Hibernate táº¡o SessionFactory tá»« cáº¥u hÃ¬nh.
            ServiceRegistry registry = new StandardServiceRegistryBuilder()
                    .applySettings(prop)
                    .build();
            //táº¡o Sessionfactory
            return new Configuration() //khá»Ÿi táº¡o
                    .addProperties(prop) //thÃªm cáº¥u hÃ¬nh vÃ o
                    .addAnnotatedClass(Category.class) //Ä‘Äƒng kÃ½ entity class Category cÃ³ @Entity
                    .buildSessionFactory(registry); // táº¡o SessionFactory
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }

    public static SessionFactory getSessionFactory() {
        return sessionFactory;
    }
}




public class HibernateTest {
    public static void main(String[] args) {
        try{
            Session session = HibernateUtils.getSessionFactory().openSession();

         //update
            Category c = session.get(Category.class, 13); // persisten
            c.setCategory_ds("Du lieu cap nhat");
        // báº­t giao tÃ¡c Ä‘á»ƒ trÃ¡nh tranh cháº¥p dá»¯ liá»‡u
            Transaction tx = session.beginTransaction();
            session.save(c); // thá»±c hiá»‡n lá»‡h cáº­p nháº­t
            tx.commit();
            
            
           // creat - khÃ´ng cáº§n táº¡o giao tÃ¡c vÃ¬ k cÃ³ ai tranh cháº¥p dá»¯ liá»‡u
            Category category = new Category();  --transient
            category.setCategory_name("Iphone");
            category.setCategory_ds("Dien Thoai DI Dong Thong Minh");
            category.setCategory_ds("telephone");
            session.save(category);

            session.close();

        }catch(Exception e){
            throw new RuntimeException(e);
        }
    }
}




ğŸ”„ Transaction lÃ  gÃ¬?
Transaction (giao dá»‹ch) lÃ  má»™t Ä‘Æ¡n vá»‹ cÃ´ng viá»‡c logic bao gá»“m má»™t hoáº·c nhiá»u thao tÃ¡c (insert, update, delete...) Ä‘Æ°á»£c thá»±c hiá»‡n nhÆ° má»™t khá»‘i nguyÃªn tá»­ (atomic). Tá»©c lÃ :

ThÃ nh cÃ´ng â†’ commit toÃ n bá»™
Lá»—i á»Ÿ giá»¯a â†’ rollback toÃ n bá»™

SELECT (chá»‰ Ä‘á»c dá»¯ liá»‡u)	    âŒ KhÃ´ng cáº§n	KhÃ´ng thay Ä‘á»•i DB, khÃ´ng lo xung Ä‘á»™t
INSERT, UPDATE, DELETE	        âœ… Cáº§n	CÃ³ thá»ƒ thay Ä‘á»•i dá»¯ liá»‡u, cáº§n Ä‘áº£m báº£o toÃ n váº¹n
Nhiá»u thao tÃ¡c liÃªn quan nhau	âœ… Cáº§n	Äáº£m báº£o atomic â€” táº¥t cáº£ hoáº·c khÃ´ng gÃ¬ cáº£
Gá»i stored procedure cÃ³ logic thay Ä‘á»•i dá»¯ liá»‡u	âœ… Cáº§n	VÃ¬ procedure cÃ³ thá»ƒ update nhiá»u báº£ng
ğŸ”¥ Khi nÃ o báº¯t buá»™c pháº£i dÃ¹ng Transaction?
    @Transactional
    public void transferMoney(Long fromId, Long toId, double amount) {
        Account from = accountRepo.findById(fromId).get();
        Account to = accountRepo.findById(toId).get();
        
        from.setBalance(from.getBalance() - amount);
        to.setBalance(to.getBalance() + amount);
        
        accountRepo.save(from);
        accountRepo.save(to);
    }
Náº¿u khÃ´ng cÃ³ @Transactional, lá»—i giá»¯a chá»«ng (VD: máº¥t káº¿t ná»‘i) sáº½ khiáº¿n tÃ i khoáº£n bá»‹ lá»‡ch, tiá»n máº¥t tÃ­ch ğŸ§¨


âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…

Entity Relationship : @ManyToOne, @ManyToMany, @OneToMany, @OneToOne

âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…

ğŸ”¹ @ManyToOne
Nhiá»u báº£n ghi á»Ÿ báº£ng nÃ y liÃªn káº¿t tá»›i 1 báº£n ghi á»Ÿ báº£ng khÃ¡c.

VÃ­ dá»¥:
    @ManyToOne
    @JoinColumn(name = "department_id")
    private Department department;

ğŸ“Œ Ã nghÄ©a:
    Nhiá»u nhÃ¢n viÃªn thuá»™c 1 phÃ²ng ban â†’ Employee lÃ  Many, Department lÃ  One.
    Táº¡o khÃ³a ngoáº¡i department_id trong báº£ng employee.


ğŸ”¹ @OneToMany
Má»™t báº£n ghi á»Ÿ báº£ng nÃ y liÃªn káº¿t Ä‘áº¿n nhiá»u báº£n ghi á»Ÿ báº£ng khÃ¡c.
    VÃ­ dá»¥
        @OneToMany(mappedBy = "department")
    private List<Employee> employees;

ğŸ“Œ Ã nghÄ©a:
    Má»™t phÃ²ng ban cÃ³ nhiá»u nhÃ¢n viÃªn.
    Quan há»‡ ngÆ°á»£c vá»›i @ManyToOne, thÆ°á»ng dÃ¹ng mappedBy Ä‘á»ƒ khÃ´ng táº¡o thÃªm báº£ng trung gian.
    âœ… NÃªn dÃ¹ng káº¿t há»£p vá»›i @ManyToOne phÃ­a cÃ²n láº¡i.

ğŸ”¹ @OneToOne
1 báº£n ghi tÆ°Æ¡ng á»©ng Ä‘Ãºng 1 báº£n ghi khÃ¡c.

VÃ­ dá»¥:
    @OneToOne
    @JoinColumn(name = "user_id")
    private User user;

ğŸ“Œ Ã nghÄ©a:
    Má»—i User cÃ³ 1 Profile, má»—i Profile thuá»™c 1 User.
    Táº¡o khÃ³a ngoáº¡i user_id á»Ÿ báº£ng profile.


ğŸ”¹@ManyToMany
Nhiá»u báº£n ghi á»Ÿ báº£ng nÃ y liÃªn káº¿t vá»›i nhiá»u báº£n ghi á»Ÿ báº£ng kia.
    VÃ­ dá»¥:
    @ManyToMany
    @JoinTable( â†’ Chá»‰ Ä‘á»‹nh tÃªn báº£ng trung gian vÃ  cÃ¡c cá»™t khÃ³a ngoáº¡i.
        name = "student_course",    â†’ TÃªn báº£ng trung gian trong database
        joinColumns = @JoinColumn(name = "student_id"),â†’ Cá»™t student_id trong báº£ng trung gian dÃ¹ng Ä‘á»ƒ liÃªn káº¿t vá»›i Student (chÃ­nh lÃ  class hiá»‡n táº¡i).
        inverseJoinColumns = @JoinColumn(name = "course_id") â†’ Cá»™t course_id trong báº£ng trung gian dÃ¹ng Ä‘á»ƒ liÃªn káº¿t vá»›i Course (class bÃªn kia).
    )
    private List<Course> courses;

ğŸ“Œ Ã nghÄ©a:
    Má»™t sinh viÃªn há»c nhiá»u mÃ´n, vÃ  má»™t mÃ´n cÃ³ nhiá»u sinh viÃªn.
    Táº¡o báº£ng trung gian student_course Ä‘á»ƒ lÆ°u quan há»‡ nhiá»u-nhiá»u.

ğŸ§  Tá»•ng káº¿t báº£ng so sÃ¡nh
Annotation	    Ã nghÄ©a	             VÃ­ dá»¥	                 Ghi nhá»›
@ManyToOne	Nhiá»u â†’ Má»™t	    Nhiá»u Employee â†’ 1 Dept 	    Táº¡o FK
@OneToMany	Má»™t â†’ Nhiá»u 	1 Dept â†’ nhiá»u Employee	DÃ¹ng    mappedBy
@OneToOne	Má»™t â†” Má»™t	    User â†” Profile	DÃ¹ng             @JoinColumn
@ManyToMany	Nhiá»u â†” Nhiá»u	Student â†” Course	        DÃ¹ng báº£ng trung gian


âœ… CÃ¡ch nhá»› ngáº¯n gá»n:
Quan há»‡	Vai trÃ²	CÃ¡ch nhá»› nhanh
@ManyToOne--	BÃªn nhiá»u---	Giá»¯ khÃ³a ngoáº¡i (@JoinColumn)
@OneToMany--	BÃªn má»™t---	DÃ¹ng mappedBy Ã¡nh xáº¡ ngÆ°á»£c



BÃ€I Táº¬P 1 @Transactional

âœ… VÃ­ dá»¥ cá»¥ thá»ƒ:    
    @Service
    public class StudentService {

        @Autowired
        private StudentRepository studentRepository;

        @Transactional
        public void updateStudent(Student student) {
            studentRepository.update(student);
            
            // Náº¿u khÃ´ng cÃ³ lá»—i â†’ commit
            // Náº¿u cÃ³ lá»—i á»Ÿ Ä‘Ã¢y â†’ rollback toÃ n bá»™
            // int x = 1 / 0; // gÃ¢y lá»—i test rollback
        }
    }

ğŸ§  Báº¡n KHÃ”NG cáº§n viáº¿t thá»§ cÃ´ng nhÆ° Hibernate thuáº§n:
    // Hibernate thuáº§n â€” cáº§n lÃ m thá»§ cÃ´ng
    Session session = sessionFactory.openSession();
    Transaction tx = session.beginTransaction();

    try {
        // thá»±c hiá»‡n thao tÃ¡c
        tx.commit();
    } catch (Exception e) {
        tx.rollback();
    }
âœ… TÃ³m láº¡i:
ğŸ‘‰ Chá»‰ cáº§n @Transactional, báº¡n Ä‘Æ°á»£c xá»­ lÃ½ Ä‘áº§y Ä‘á»§ transaction â€” khÃ´ng cáº§n code thá»§ cÃ´ng beginTransaction(), commit(), rollback() ná»¯a



ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ 

ViewResolver â†’ Ã¡nh xáº¡ view: âœ…

DataSource â†’ driver, url, user/pass: âœ…

Properties â†’ cáº¥u hÃ¬nh hibernate: âœ…

SessionFactory â†’ add properties, scan package cÃ³ @Entity: âœ…

TransactionManager â†’ quáº£n lÃ½ giao dá»‹ch: âœ…

ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ ğŸ§ 


âœ… 1. Cascade lÃ  gÃ¬?
Cascade dÃ¹ng Ä‘á»ƒ chá»‰ Ä‘á»‹nh cÃ¡c thao tÃ¡c tá»± Ä‘á»™ng lan sang entity liÃªn quan.

VÃ­ dá»¥: Khi báº¡n lÆ°u, xoÃ¡, hay merge má»™t entity cha, thÃ¬ cÃ¡c entity con liÃªn quan cÃ³ Ä‘Æ°á»£c thá»±c hiá»‡n thao tÃ¡c tÆ°Æ¡ng á»©ng khÃ´ng?

ğŸ’¡ VÃ­ dá»¥ dá»… hiá»ƒu:

@OneToMany(mappedBy = "category", cascade = CascadeType.ALL)
private List<Product> products;
    ğŸ‘‰ Khi báº¡n save(Category) â†’ JPA sáº½ tá»± Ä‘á»™ng save táº¥t cáº£ Product trong danh sÃ¡ch Ä‘Ã³ mÃ  báº¡n khÃ´ng cáº§n gá»i riÃªng tá»«ng cÃ¡i.

ğŸ¯ CÃ¡c loáº¡i CascadeType:
CascadeType	    Ã nghÄ©a
ALL     	Gá»“m táº¥t cáº£ cÃ¡c hÃ nh Ä‘á»™ng bÃªn dÆ°á»›i
PERSIST	    Khi gá»i persist() entity cha thÃ¬ persist luÃ´n entity con
MERGE	    Khi gá»i merge() thÃ¬ merge luÃ´n cÃ¡c entity con
REMOVE	    Khi xoÃ¡ entity cha thÃ¬ tá»± Ä‘á»™ng xoÃ¡ entity con
REFRESH	    Khi gá»i refresh() thÃ¬ cáº­p nháº­t láº¡i entity con
DETACH	    Khi gá»i detach() thÃ¬ tÃ¡ch luÃ´n entity con khá»i persistence context


ğŸ› ï¸ VÃ­ dá»¥ vá» Cascade:
    @OneToMany(mappedBy = "customer", cascade = CascadeType.PERSIST)
    private List<Invoince> invoices;

  ğŸ‘‰  Khi báº¡n lÆ°u má»™t Customer cÃ³ invoices, Hibernate sáº½ tá»± Ä‘á»™ng lÆ°u Invoice vÃ o database
 

âœ… 2. FetchType lÃ  gÃ¬?
FetchType dÃ¹ng Ä‘á»ƒ chá»‰ Ä‘á»‹nh cÃ¡ch JPA táº£i dá»¯ liá»‡u quan há»‡ khi truy váº¥n.

ğŸ¯ CÃ³ 2 loáº¡i chÃ­nh:
    FetchType	    Ã nghÄ©a
    EAGER	    Táº£i ngay láº­p tá»©c quan há»‡ khi truy váº¥n entity cha
    LAZY	    Chá»‰ táº£i khi cáº§n (truy cáº­p Ä‘áº¿n má»›i truy váº¥n

ğŸ’¡ VÃ­ dá»¥:
    @OneToMany(mappedBy = "category", fetch = FetchType.LAZY)
    private List<Product> products;

Khi báº¡n gá»i Category c = session.get(Category.class, 1);
â†’ Danh sÃ¡ch products sáº½ chÆ°a Ä‘Æ°á»£c táº£i cho Ä‘áº¿n khi báº¡n gá»i c.getProducts().


âš ï¸ LÆ°u Ã½ khi dÃ¹ng LAZY:
Náº¿u dÃ¹ng LAZY nhÆ°ng session Ä‘Ã£ Ä‘Ã³ng rá»“i, vÃ  báº¡n gá»i getProducts() â†’ lá»—i:
    LazyInitializationException

    CÃ¡ch xá»­ lÃ½:
DÃ¹ng DTO Ä‘á»ƒ map khi session cÃ²n má»Ÿ
DÃ¹ng fetch join trong JPQL/HQL


âœ… Gá»£i Ã½ cáº¥u hÃ¬nh chuáº©n cho thá»±c táº¿:
    ManyToOne: thÆ°á»ng lÃ  EAGER (default)

    @ManyToOne(fetch = FetchType.EAGER, cascade = CascadeType.PERSIST)
    @JoinColumn(name = "category_id")
    private Category category;

    OneToMany: thÆ°á»ng nÃªn lÃ  LAZY Ä‘á»ƒ trÃ¡nh náº·ng

    @OneToMany(mappedBy = "category", fetch = FetchType.LAZY, cascade = CascadeType.ALL)
    private List<Product> products;





ğŸ§¨ Váº¥n Ä‘á»: N + 1 Query
Khi báº¡n thá»±c hiá»‡n truy váº¥n nhÆ° sau:

    List<Customer> customers = customerRepository.findAll(); // Truy váº¥n 1

    for (Customer customer : customers) {
        List<Invoice> invoices = customer.getInvoices(); // Truy váº¥n N láº§n (má»—i customer má»™t truy váº¥n)
    }



ğŸ‘‰ Tá»•ng sá»‘ truy váº¥n SQL: 1 + N
    Náº¿u cÃ³ 1000 khÃ¡ch hÃ ng â†’ 1 + 1000 = 1001 truy váº¥n
    âŒ á»¨ng dá»¥ng ráº¥t cháº­m, tá»‘n tÃ i nguyÃªn

âœ… Giáº£i phÃ¡p: TrÃ¡nh N + 1 Query báº±ng Join Fetch
âœ… 1. DÃ¹ng @Query vá»›i JOIN FETCH trong repository

@Query("SELECT c FROM Customer c LEFT JOIN FETCH c.invoices")
List<Customer> findAllWithInvoices();

Hibernate chá»‰ thá»±c hiá»‡n 1 truy váº¥n duy nháº¥t:
SELECT c.*, i.* 
FROM customer c
LEFT JOIN invoice i ON i.customer_id = c.id

âš ï¸ Vá»›i quan há»‡ OneToMany thÃ¬ káº¿t quáº£ sáº½ bá»‹ "nhÃ¢n báº£n" khÃ¡ch hÃ ng náº¿u cÃ³ nhiá»u hoÃ¡ Ä‘Æ¡n â†’ dÃ¹ng Set hoáº·c DISTINCT Ä‘á»ƒ xá»­ lÃ½.


âœ… 2. DÃ¹ng EntityGraph (náº¿u báº¡n khÃ´ng muá»‘n viáº¿t JPQL)

@EntityGraph(attributePaths = "invoices")
@Query("SELECT c FROM Customer c")
List<Customer> findAllWithInvoices();

CÃ¡ch nÃ y sá»­ dá»¥ng annotation Ä‘á»ƒ khai bÃ¡o quan há»‡ cáº§n fetch, khÃ´ng cáº§n viáº¿t JOIN.


âœ… 3. Sá»­ dá»¥ng DTO Ä‘á»ƒ custom query (truy váº¥n dáº¡ng káº¿t há»£p)

    @Query("SELECT new com.example.dto.CustomerInvoiceDTO(c.name, i.totalAmount) " +
       "FROM Customer c LEFT JOIN c.invoices i")
    ist<CustomerInvoiceDTO> findCustomerInvoiceInfo();

 CÃ¡ch nÃ y truy váº¥n Ä‘Ãºng dá»¯ liá»‡u cáº§n, nháº¹ hÆ¡n ráº¥t nhiá»u vÃ¬ khÃ´ng pháº£i load cáº£ object.



âœ… 3. Káº¿t há»£p Cascade vÃ  Fetching - Má»™t vÃ­ dá»¥ thá»±c táº¿
Má»™t KhÃ¡ch hÃ ng (Customer) cÃ³ nhiá»u HÃ³a Ä‘Æ¡n (Invoice)
Khi lÆ°u khÃ¡ch hÃ ng má»›i, cÅ©ng muá»‘n lÆ°u luÃ´n hÃ³a Ä‘Æ¡n liÃªn quan
Khi láº¥y thÃ´ng tin khÃ¡ch hÃ ng, chá»‰ cáº§n láº¥y danh sÃ¡ch hÃ³a Ä‘Æ¡n khi cáº§n

VÃ Dá»¤: 
ğŸ”¹   Cascade â†’ Ä‘á»ƒ lÆ°u khÃ¡ch hÃ ng vÃ  hÃ³a Ä‘Æ¡n cÃ¹ng lÃºc
ğŸ”¹   FetchType.LAZY â†’ Ä‘á»ƒ chá»‰ táº£i danh sÃ¡ch hÃ³a Ä‘Æ¡n khi tháº­t sá»± cáº§n
ğŸ”¹"Customer cÃ³ nhiá»u Invoice" â†’ quan há»‡ @OneToMany


    âœ… 1. Cáº¥u trÃºc Entity: Customer vÃ  Invoice

ğŸ”¹ Customer.java
        @Entity
        @Table(name = "customer")
        public class Customer {
            @Id
            @GeneratedValue(strategy = GenerationType.IDENTITY)
            private Long id;

            private String name;

            // Má»™t khÃ¡ch hÃ ng cÃ³ nhiá»u hÃ³a Ä‘Æ¡n
            @OneToMany(mappedBy = "customer", 
                    cascade = CascadeType.PERSIST, 
                    fetch = FetchType.LAZY)
            private List<Invoice> invoices;

            // Getter, Setter, Constructor
        }


ğŸ”¹ Invoice.java
        @Entity
        @Table(name = "invoice")
        public class Invoice {

            @Id
            @GeneratedValue(strategy = GenerationType.IDENTITY)
            private Long id;

            private Double amount;

            @ManyToOne(fetch = FetchType.LAZY)
            @JoinColumn(name = "customer_id")
            private Customer customer;

            // Getter, Setter, Constructor
        }


âœ… 2. LÆ°u má»™t Customer cÃ¹ng vá»›i danh sÃ¡ch hÃ³a Ä‘Æ¡n

        Customer customer = new Customer();
        customer.setName("Nguyá»…n VÄƒn A");

        Invoice invoice1 = new Invoice();
        invoice1.setAmount(1000.0);
        invoice1.setCustomer(customer); // pháº£i gáº¯n ngÆ°á»£c láº¡i

        Invoice invoice2 = new Invoice();
        invoice2.setAmount(2000.0);
        invoice2.setCustomer(customer); // gáº¯n ngÆ°á»£c láº¡i

        customer.setInvoices(List.of(invoice1, invoice2));

        customerRepository.save(customer); // âœ… Cascade sáº½ lÆ°u luÃ´n invoice1 vÃ  invoice2


âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…
PhÃ¢n trang trong Hibernate 

NguyÃªn lÃ½ PhÃ¢n trang trong Hibernate
 há»— trá»£ phÃ¢n trang thÃ´ng qua hai phÆ°Æ¡ng thá»©c chÃ­nh trÃªn Ä‘á»‘i tÆ°á»£ng Query hoáº·c TypedQuery:

 setFirstResult(int): XÃ¡c Ä‘á»‹nh vá»‹ trÃ­ báº£n ghi báº¯t Ä‘áº§u láº¥y káº¿t quáº£ (OFFSET)
 setMaxResults(int): Giá»›i háº¡n sá»‘ báº£n ghi tá»‘i Ä‘a cáº§n láº¥y (LIMIT)

 LIMIT VS OFFSET DÃ™NG TRONG SQL NHÆ¯NG HQL KHÃ”NG Há»– TRá»¢ NÃŠN PHáº¢I DÃ™NG setFirstResult VS  setMaxResults

 âœ… CÃ¡ch phÃ¢n trang báº±ng Hibernate thuáº§n (Session + Query)
 ğŸ“Œ VÃ­ dá»¥:
        Session session = sessionFactory.openSession();

        Query<Customer> query = session.createQuery("FROM Customer", Customer.class);

        // Thiáº¿t láº­p phÃ¢n trang: láº¥y 10 báº£n ghi, báº¯t Ä‘áº§u tá»« báº£n ghi thá»© 0
        query.setFirstResult(0); // OFFSET = (pageNumber - 1) * pageSize
        query.setMaxResults(10); // LIMIT Sá»‘ lÆ°á»£ng báº£n ghi muá»‘n láº¥y

        List<Customer> customers = query.getResultList();

Káº¿t quáº£: Láº¥y 10 khÃ¡ch hÃ ng Ä‘áº§u tiÃªn.

âœ… 4. Ãp dá»¥ng cho phÃ¢n trang nhiá»u trang:
Giáº£ sá»­:

Trang 1: offset = 0

Trang 2: offset = 10

Trang 3: offset = 20
(vá»›i pageSize = 10)

        int pageNumber = 2;
        int pageSize = 10;

        Query<Customer> query = session.createQuery("FROM Customer", Customer.class);
        query.setFirstResult((pageNumber - 1) * pageSize);
        query.setMaxResults(pageSize);

âœ… 5. Náº¿u dÃ¹ng Spring Data JPA thÃ¬ dá»… hÆ¡n nhiá»u

    Pageable pageable = PageRequest.of(pageNumber, pageSize);
    Page<Customer> page = customerRepository.findAll(pageable);

    List<Customer> customers = page.getContent();
    int totalPages = page.getTotalPages();
    long totalElements = page.getTotalElements();

THá»°C Táº¾ THÃŒ CÃCH NÃ€Y ÄÆ¯á»¢C DÃ™NG PHá»” BIáº¾N NHáº¤T (Spring Data JPA)
    âœ… 1. DÃ¹ng phÃ¢n trang trong Spring Data JPA
    ğŸ‘‰ BÆ°á»›c 1: Viáº¿t Repository
        public interface CustomerRepository extends JpaRepository<Customer, Long> {
        // tá»± cÃ³ sáºµn phÆ°Æ¡ng thá»©c: findAll(Pageable pageable)
    }

    ğŸ‘‰ BÆ°á»›c 2: Gá»i trong service hoáº·c controller
    @GetMapping("/customers")
    public String listCustomers(@RequestParam(defaultValue = "0") int page,
                                @RequestParam(defaultValue = "10") int size,
                                Model model) {

        Pageable pageable = PageRequest.of(page, size);
        Page<Customer> customerPage = customerRepository.findAll(pageable);

        model.addAttribute("customers", customerPage.getContent()); // danh sÃ¡ch khÃ¡ch hÃ ng
        model.addAttribute("currentPage", page);
        model.addAttribute("totalPages", customerPage.getTotalPages());
        return "list-customer";
    }


    âœ… 2. Tham sá»‘ truy váº¥n (@RequestParam) sáº½ Ä‘áº¿n tá»« giao diá»‡n:
    #html
    <!-- Giao diá»‡n phÃ¢n trang -->
    <a href="/customers?page=0&size=10">Trang 1</a>
    <a href="/customers?page=1&size=10">Trang 2</a>
    ...

    ğŸ‘‰ Tham sá»‘ tá»« giao diá»‡n (page, size) sáº½ trá»Ÿ thÃ nh query parameter, vÃ  Spring sáº½ truyá»n vÃ o controller thÃ´ng qua @RequestParam.

 â—Máº·c dÃ¹ JpaRepository giÃºp báº¡n code cá»±c ká»³ nhanh vÃ  ngáº¯n gá»n, nÃ³ khÃ´ng Ä‘áº£m báº£o hiá»‡u suáº¥t tá»‘i Æ°u náº¿u báº¡n dÃ¹ng â€œmáº·c Ä‘á»‹nhâ€ khÃ´ng kiá»ƒm soÃ¡t.   

 âœ… Váº­y muá»‘n tá»‘i Æ°u hiá»‡u suáº¥t thÃ¬ cáº§n lÃ m gÃ¬?
Tá»‘i Æ°u gÃ¬                                   CÃ¡ch thá»±c hiá»‡n
âœ… Giá»›i háº¡n dá»¯ liá»‡u	                DÃ¹ng findAll(Pageable) thay vÃ¬ findAll()
âœ… Táº£i cÃ³ chá»n lá»c (selective loading)	DÃ¹ng @EntityGraph, JOIN FETCH, hoáº·c DTO
âœ… Giáº£m sá»‘ lÆ°á»£ng query	    TrÃ¡nh N+1 báº±ng JOIN FETCH hoáº·c fetch batch
âœ… DÃ¹ng DTO thay vÃ¬ tráº£ vá» Entity	    Chá»‰ láº¥y field cáº§n thiáº¿t â†’ trÃ¡nh táº£i dÆ°
âœ… Truy váº¥n tÃ¹y chá»‰nh	    DÃ¹ng @Query, native SQL khi cáº§n hiá»‡u suáº¥t cao
âœ… Caching              	DÃ¹ng @Cacheable, Redis, hoáº·c L2 cache (ehcache...)
âœ… Tá»‘i Æ°u transaction scope	    Chá»‰ má»Ÿ transaction á»Ÿ service, khÃ´ng kÃ©o dÃ i
.




âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…
Tá»‘i Æ°u truy váº¥n trong Hibernate

âœ… 1. DÃ¹ng Fetch Type há»£p lÃ½ (LAZY vs EAGER)
    âš ï¸ Váº¥n Ä‘á»:
    Máº·c Ä‘á»‹nh @ManyToOne lÃ  EAGER â€” dá»… gÃ¢y ra N+1 query hoáº·c táº£i dá»¯ liá»‡u khÃ´ng cáº§n thiáº¿t.

    âœ… Giáº£i phÃ¡p:
    Sá»­ dá»¥ng FetchType.LAZY á»Ÿ cÃ¡c má»‘i quan há»‡:
        @ManyToOne(fetch = FetchType.LAZY)
        private Category category;
    Chá»‰ truy cáº­p khi cáº§n, trÃ¡nh auto-load liÃªn káº¿t.

âœ… 2. DÃ¹ng Fetch Join thay vÃ¬ lazy load thá»§ cÃ´ng
    âš ï¸ Váº¥n Ä‘á»:
    Lazy load = nhiá»u query â†’ cháº­m

    âœ… Giáº£i phÃ¡p:
    Sá»­ dá»¥ng JOIN FETCH Ä‘á»ƒ láº¥y luÃ´n dá»¯ liá»‡u liÃªn quan chá»‰ báº±ng 1 query:
        @Query("SELECT p FROM Product p JOIN FETCH p.category")
        List<Product> findAllWithCategory();


âœ… 3. DÃ¹ng DTO projection thay vÃ¬ entity
    âš ï¸ Váº¥n Ä‘á»:
    SELECT * â†’ load toÃ n bá»™ entity (ká»ƒ cáº£ trÆ°á»ng khÃ´ng dÃ¹ng)

    âœ… Giáº£i phÃ¡p:
    Truy váº¥n chá»‰ láº¥y cÃ¡c trÆ°á»ng cáº§n thiáº¿t â†’ DTO projection:
        @Query("SELECT new com.example.dto.ProductDTO(p.id, p.name) FROM Product p")
        List<ProductDTO> getAllProductNames();
â†’ Nhanh hÆ¡n nhiá»u so vá»›i load cáº£ entity


âœ… 4. DÃ¹ng pagination (setFirstResult, setMaxResults)
âš ï¸ Váº¥n Ä‘á»:
Truy váº¥n toÃ n bá»™ báº£ng cÃ³ thá»ƒ gÃ¢y OOM hoáº·c cháº­m

âœ… Giáº£i phÃ¡p:
Ãp dá»¥ng phÃ¢n trang:

    TypedQuery<Product> query = em.createQuery("FROM Product", Product.class);
    query.setFirstResult(0);
    query.setMaxResults(20);

Trong Spring Data JPA:

    Page<Product> findByStatus(String status, Pageable pageable);


âœ… 5. Báº­t batch_size vÃ  dÃ¹ng batch insert/update
    âš ï¸ Váº¥n Ä‘á»:
    Hibernate máº·c Ä‘á»‹nh gá»­i tá»«ng cÃ¢u SQL má»™t â†’ cháº­m!

    âœ… Giáº£i phÃ¡p:

    hibernate.jdbc.batch_size=30
    hibernate.order_inserts=true
    hibernate.order_updates=true

  Sau Ä‘Ã³:  

    for (int i = 0; i < list.size(); i++) {
        em.persist(list.get(i));
        if (i % 30 == 0) {
            em.flush();
            em.clear();
        }
    }


âœ… 6. TrÃ¡nh N+1 báº±ng EntityGraph (Spring JPA)

    @EntityGraph(attributePaths = "category")
    List<Product> findAll();


âœ… 7. Index há»£p lÃ½ á»Ÿ DB
Hibernate khÃ´ng lo pháº§n nÃ y cho báº¡n. Báº¡n nÃªn:

Index cÃ¡c cá»™t hay tÃ¬m kiáº¿m (WHERE, JOIN)

DÃ¹ng Explain plan trong DB Ä‘á»ƒ kiá»ƒm tra hiá»‡u suáº¥t


âœ… 8. Truy váº¥n native (náº¿u cáº§n tá»‘i Æ°u sÃ¢u)
Khi JPQL khÃ´ng Ä‘á»§ hiá»‡u quáº£ hoáº·c muá»‘n dÃ¹ng stored procedure, index hint, view, v.v.

    @Query(value = "SELECT * FROM products WHERE price > ?", nativeQuery = true)
    List<Product> findExpensive(double price);


âœ… 9. Sá»­ dá»¥ng @BatchSize cho liÃªn káº¿t LAZY
Hibernate sáº½ gom nhiá»u truy váº¥n lazy vÃ o 1 láº§n:

    @BatchSize(size = 10)
    @OneToMany(fetch = FetchType.LAZY, mappedBy = "user")
    private List<Order> orders;


âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…

Data Binding trong Spring MVC

Spring MVC sáº½ tá»± Ä‘á»™ng Ã¡nh xáº¡ (bind) dá»¯ liá»‡u tá»« cÃ¡c trÆ°á»ng input trong form HTML vÃ o thuá»™c tÃ­nh cá»§a object Java (Model object) dá»±a trÃªn tÃªn (name) cá»§a cÃ¡c trÆ°á»ng input vÃ  cáº¥u trÃºc object.

âœ… CÃ¡ch hoáº¡t Ä‘á»™ng cÆ¡ báº£n:
1. Form HTML gá»­i dá»¯ liá»‡u (qua GET hoáº·c POST)

2. Spring MVC dÃ¹ng @ModelAttribute (hoáº·c tá»± Ä‘á»™ng) Ä‘á»ƒ táº¡o vÃ  populate object tá»« cÃ¡c trÆ°á»ng cÃ³ name=...

3. CÃ¡c giÃ¡ trá»‹ input, select, textarea,... Ä‘Æ°á»£c gÃ¡n vÃ o cÃ¡c thuá»™c tÃ­nh tÆ°Æ¡ng á»©ng cá»§a object theo tÃªn name

ğŸ“¦ VÃ­ dá»¥ Ä‘Æ¡n giáº£n:
âœ… 1. Java model:
    public class Product {
        private String productName;
        private float price;
        private Category catalog;
    }
    public class Category {
        private String categoryId;
        private String categoryName;
    }

 âœ… 2. Form HTML:
 
    <form action="/productController/createProduct" method="post">
    <input type="text" name="productName" />
    <input type="text" name="price" />
    <select name="catalog.categoryId">
        <option value="C01">Coffee</option>
        <option value="C02">Tea</option>
    </select>
    <button type="submit">Create</button>
    </form>


âœ… 3. Controller:
    @PostMapping("/createProduct")
    public String createProduct(@ModelAttribute Product product) {
        // Spring sáº½ tá»± Ä‘á»™ng bind cÃ¡c field tá»« form vÃ o object product
        productService.save(product); 
        return "redirect:/productList";
    }

ğŸ” NgÆ°á»£c láº¡i â€“ Binding ngÆ°á»£c tá»« object ra form (JSP):

    <input type="text" name="productName" value="${product.productName}" />
        <select name="catalog.categoryId">
            <c:forEach items="${categoryList}" var="cat">
                <option value="${cat.categoryId}" 
                <c:if test="${product.catalog.categoryId == cat.categoryId}">selected</c:if>>
                ${cat.categoryName}
                </option>
            </c:forEach>
        </select>


âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…

Táº¡o form HTML vá»›i Spring Form Tag Library

âœ… BÆ°á»›c 1: Cáº¥u hÃ¬nh JSP há»— trá»£ Spring Form<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form" %>

âœ… BÆ°á»›c 2: Model Java (VÃ­ dá»¥: Product)
public class Product {
    private String productName;
    private float price;
    private Category catalog;

    // getters & setters
}

public class Category {
    private String categoryId;
    private String categoryName;

    // getters & setters
}

âœ… BÆ°á»›c 3: Controller

@Controller
@RequestMapping("/productController")
public class ProductController {

    @GetMapping("/initCreate")
    public String initCreate(Model model) {
        model.addAttribute("product", new Product());
        model.addAttribute("categoryList", categoryService.findAll());
        return "productForm";
    }

    @PostMapping("/createProduct")
    public String createProduct(@ModelAttribute("product") Product product) {
        product.setProductId(UUID.randomUUID().toString().substring(0, 5));
        productService.saveProduct(product);
        return "redirect:/productController/productList";
    }
}


âœ… BÆ°á»›c 4: JSP dÃ¹ng form: tag (productForm.jsp)

<%@ taglib uri="http://www.springframework.org/tags/form" prefix="form" %>

<h2>Create Product</h2>

<form:form modelAttribute="product" action="${pageContext.request.contextPath}/productController/createProduct" method="post">
    <label>Product Name:</label>
    <form:input path="productName" /><br/>

    <label>Price:</label>
    <form:input path="price" /><br/>

    <label>Category:</label>
    <form:select path="catalog.categoryId">
        <form:options items="${categoryList}" itemValue="categoryId" itemLabel="categoryName"/>
    </form:select><br/>

    <input type="submit" value="Save"/>
</form:form>



âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…
Bean Validation
âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…

âœ… 1. Bean Validation lÃ  gÃ¬?
Bean Validation lÃ  má»™t chuáº©n (JSR-303 vÃ  JSR-380) dÃ¹ng Ä‘á»ƒ kiá»ƒm tra rÃ ng buá»™c (validation) trÃªn cÃ¡c thuá»™c tÃ­nh cá»§a Ä‘á»‘i tÆ°á»£ng Java.

âœ… 2. Má»™t sá»‘ Annotation thÆ°á»ng dÃ¹ng

 Annotation	    Ã nghÄ©a
@NotNull	    KhÃ´ng Ä‘Æ°á»£c null
@NotBlank	    KhÃ´ng rá»—ng (Ã¡p dá»¥ng vá»›i String)
@Size(min, max)	Äá»™ dÃ i chuá»—i
@Min, @Max	    GiÃ¡ trá»‹ nhá»/lá»›n nháº¥t
@Email	        ÄÃºng Ä‘á»‹nh dáº¡ng email
@Pattern	    Kiá»ƒm tra theo Regex
@Past/@Future   Pháº£i lÃ  ngÃ y trong quÃ¡ khá»© / ngÃ y trong tÆ°Æ¡ng lai

    
âœ…3. VÃ­ dá»¥ Ä‘Æ¡n giáº£n
Java Bean (DTO hoáº·c Form)

#Java Bean

    public class UserDTO {
        @NotBlank(message = "tÃªn khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng")
        private String name;

        @Email(message = "Email khÃ´ng há»£p lá»‡")
        private String email;

        @Min(value = 18, message = "giÃ¡ trá»‹ pháº£i lá»›n hÆ¡n 18")
        private int age;

        //getter, setter
    }

#Controller
        @PostMapping("/register")
        public String register(
                @Valid @ModelAttribute("user")UserDTO user,
                BindingResult result,
                Model model) {
            if (result.hasErrors()) {
                return "registerForm"; // tráº£ láº¡i trang form vá»›i lá»—i
            }
            //xÆ° lÃ½ lÆ°u user
            userService.save(user);
           return "redirect:/getAll";
        }

Giáº£i thÃ­ch:
@Valid kÃ­ch hoáº¡t validation
BindingResult chá»©a cÃ¡c lá»—i náº¿u cÃ³
Náº¿u cÃ³ lá»—i: result.hasErrors() == true, ta render láº¡i form cÃ¹ng vá»›i thÃ´ng bÃ¡o lá»—i
 

 

ğŸŒ±Má»™t sá»‘ lÆ°u Ã½ thá»±c táº¿
â— LÆ°u Ã½ quan trá»ng: BindingResult pháº£i Ä‘á»©ng ngay sau @Valid (hoáº·c @Validated), náº¿u khÃ´ng Spring sáº½ nÃ©m MethodArgumentNotValidException.
â— KhÃ´ng nÃªn validate trong Entity, nÃªn tÃ¡ch sang DTO
â—CÃ³ thá»ƒ táº¡o custom annotation báº±ng cÃ¡ch implements ConstraintValidator

Xá»­ lÃ½ lá»—i vá»›i BindingResult trong Spring form

ğŸ–¼ï¸ 1. Trong view (JSP hoáº·c Thymeleaf)
<form:form modelAttribute="user" method="post">
    <div>
        <label>TÃªn ngÆ°á»i dÃ¹ng:</label>
        <form:input path="name" />
        <form:errors path="name" cssClass="error" /> -- cssClass: náº¿u cÃ³ lá»—i sáº½ kÃ­ch hoáº¡t class Css Ä‘Ã³ lÃªn
    </div>
...email

form:errors sáº½ tá»± Ä‘á»™ng hiá»ƒn thá»‹ thÃ´ng bÃ¡o lá»—i tÆ°Æ¡ng á»©ng vá»›i BindingResult.

ğŸ› ï¸ 2. VÃ­ dá»¥ Ä‘áº§y Ä‘á»§
âœ… DTO vá»›i annotation:
    public class UserDTO {
        @NotBlank(message = "TÃªn khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng")
        private String name;

        @Email(message = "Email khÃ´ng há»£p lá»‡")
        @NotBlank(message = "Email khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng")
        private String email;

        // getter/setter
    }

âœ… Controller:
    @GetMapping("/initCreate")
    public String initCreate(Model model) {
        model.addAttribute("user", new UserDTO());
        return "userForm";
    }

    @PostMapping("/create")
    public String createUser(@Valid @ModelAttribute("user") UserDTO user,
                            BindingResult bindingResult,
                            Model model) {
        if (bindingResult.hasErrors()) {
            return "userForm";  // quay láº¡i form náº¿u lá»—i
        }

        // logic xá»­ lÃ½ náº¿u há»£p lá»‡
        userService.save(user);
        return "redirect:/users";
    }

ğŸ§© Khi ngÆ°á»i dÃ¹ng nháº­p sai Ä‘á»‹nh dáº¡ng (vi pháº¡m @Valid nhÆ° @Email, @NotBlank, @Size, v.v):
Spring tá»± Ä‘á»™ng binding dá»¯ liá»‡u tá»« form â†’ vÃ o DTO (vÃ­ dá»¥ UserDTO).

Náº¿u cÃ³ lá»—i:

Spring váº«n giá»¯ láº¡i toÃ n bá»™ dá»¯ liá»‡u ngÆ°á»i dÃ¹ng vá»«a nháº­p trong userDTO.

Nhá»¯ng lá»—i vi pháº¡m sáº½ Ä‘Æ°á»£c ghi vÃ o BindingResult.

Khi báº¡n tráº£ vá» return "form":

Spring sáº½ Ä‘Æ°a láº¡i userDTO (Ä‘Ã£ cÃ³ dá»¯ liá»‡u ngÆ°á»i dÃ¹ng nháº­p).

VÃ  BindingResult chá»©a lá»—i â†’ Ä‘Æ°á»£c view sá»­ dá»¥ng Ä‘á»ƒ hiá»ƒn thá»‹ lá»—i.




âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…

Custom Annotation Validator

âœ… Khi nÃ o cáº§n Custom Validator?
DÃ¹ng khi:

Annotation chuáº©n nhÆ° @NotBlank, @Email, @Size,... khÃ´ng Ä‘á»§ Ä‘Ã¡p á»©ng logic báº¡n muá»‘n kiá»ƒm tra.

âœ…VÃ­ dá»¥:

    Kiá»ƒm tra username khÃ´ng trÃ¹ng vá»›i trong DB
    Kiá»ƒm tra password pháº£i chá»©a chá»¯ hoa + sá»‘ + kÃ½ tá»± Ä‘áº·c biá»‡t

ğŸ“¦ 1. CÃ¡ch táº¡o Custom Annotation Validator
     ğŸ§± BÆ°á»›c 1: Táº¡o annotation má»›i
        @Documented
        @Constraint(validatedBy = MyConstraintValidator.class)
        @Target({ ElementType.FIELD })
        @Retention(RetentionPolicy.RUNTIME)
        public @interface MyCustom {

            String message() default "GiÃ¡ trá»‹ khÃ´ng há»£p lá»‡";

            Class<?>[] groups() default {};

            Class<? extends Payload>[] payload() default {};
        }

 ğŸ› ï¸ BÆ°á»›c 2: Táº¡o class xá»­ lÃ½ logic kiá»ƒm tra

 public class MyConstraintValidator implements ConstraintValidator<MyCustom, String> {

    @Override
    public void initialize(MyCustom constraintAnnotation) {
        // Khá»Ÿi táº¡o náº¿u cáº§n
    }

    @Override
    public boolean isValid(String value, ConstraintValidatorContext context) {
        // Logic kiá»ƒm tra
        if (value == null) return false;
        return value.startsWith("ABC"); // VÃ­ dá»¥: chá»‰ cho phÃ©p báº¯t Ä‘áº§u báº±ng "ABC"
    }
}


ğŸ“¥ 2. DÃ¹ng trong DTO nhÆ° annotation bÃ¬nh thÆ°á»ng

    public class UserDTO {
        @MyCustom(message = "TÃªn pháº£i báº¯t Ä‘áº§u báº±ng ABC")
        private String name;

        // getter, setter
    }


ğŸ¯ VÃ­ dá»¥ thá»±c táº¿ hÆ¡n: @ValidPassword
âœ… 1. Annotation:

    @Documented
    @Constraint(validatedBy = PasswordValidator.class)
    @Target({ ElementType.FIELD })
    @Retention(RetentionPolicy.RUNTIME)
    public @interface ValidPassword {
        String message() default "Máº­t kháº©u khÃ´ng há»£p lá»‡";
        Class<?>[] groups() default {};
        Class<? extends Payload>[] payload() default {};
    }

âœ… 2. Validator logic:

    public class PasswordValidator implements ConstraintValidator<ValidPassword, String> {
    private static final String PASSWORD_PATTERN =
            "^(?=.*[A-Z])(?=.*[a-z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]{8,}$";
    @Override
    public boolean isValid(String value, ConstraintValidatorContext context) {
        return value != null && value.matches(PASSWORD_PATTERN);
    }
}


âœ… 3. DÃ¹ng trong DTO:
    public class UserDTO {
        @ValidPassword(message = "Máº­t kháº©u pháº£i cÃ³ chá»¯ hoa, chá»¯ thÆ°á»ng, sá»‘ vÃ  kÃ½ tá»± Ä‘áº·c biá»‡t")
        private String password;
    }


TRÆ¯á»œNG Há»¢P PHáº¢I DÃ™NG CUSTOMANOTATION

ğŸ”¥NgÃ y sinh â†’ TÃ­nh tuá»•i â†’ Kiá»ƒm tra â‰¥ 18
â†’ TrÆ°á»ng há»£p nÃ y:
    Báº¡n khÃ´ng nháº­p age mÃ  nháº­p birthday (LocalDate)
    Pháº£i tÃ­nh tuá»•i tá»« ngÃ y sinh â†’ @Min khÃ´ng dÃ¹ng Ä‘Æ°á»£c

ğŸ“¦ 1. Táº¡o Annotation @ValidAge
    @Documented
    @Constraint(validatedBy = ValidAgeValidator.class)
    @Target({ ElementType.FIELD })
    @Retention(RetentionPolicy.RUNTIME)
    public @interface ValidAge {
        String message() default "Tuá»•i pháº£i tá»« {min} trá»Ÿ lÃªn";

        int min() default 18;

        Class<?>[] groups() default {};

        Class<? extends Payload>[] payload() default {};
    }

âš™ï¸ 2. Viáº¿t ValidAgeValidator
    public class ValidAgeValidator implements ConstraintValidator<ValidAge, LocalDate> {

        private int minAge;

        @Override
        public void initialize(ValidAge constraintAnnotation) {
            this.minAge = constraintAnnotation.min();
        }

        @Override
        public boolean isValid(LocalDate birthday, ConstraintValidatorContext context) {
            if (birthday == null) return true; // Ä‘á»ƒ @NotNull xá»­ lÃ½ náº¿u cáº§n

            LocalDate today = LocalDate.now();
            Period age = Period.between(birthday, today);
            return age.getYears() >= minAge;
        }
    }


ğŸ“˜ 3. DÃ¹ng trong UserDTO

public class UserDTO {

    @NotNull(message = "NgÃ y sinh khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng")
    @Past(message = "NgÃ y sinh pháº£i lÃ  quÃ¡ khá»©")
    @ValidAge(min = 18, message = "Tuá»•i pháº£i tá»« 18 trá»Ÿ lÃªn")
    private LocalDate birthday;

    // getter, setter
}
